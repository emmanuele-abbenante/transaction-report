--Expenses grouped by kind and period
SELECT *
FROM (
	SELECT 
	C.EXPENSE_KIND AS Spesa,
	''  AS Controparte,
	DATE_FORMAT(VALUE_DATE, "%Y-%m") AS Periodo,
	SUM(CURRENCY_AMOUNT) AS Importo
	FROM TRANSACTIONS T
	JOIN COUNTERPARTIES C ON T.COUNTERPART = C.NAME
	GROUP BY Spesa, Periodo
) AS TRANSACTIONS_BY_KIND_PERIOD

UNION

SELECT *
FROM (
	SELECT 
	REASON AS Spesa,
	COUNTERPART AS Controparte,
	DATE_FORMAT(VALUE_DATE, "%Y-%m") AS Periodo,
	SUM(CURRENCY_AMOUNT) AS Importo
	FROM TRANSACTIONS T
	LEFT JOIN COUNTERPARTIES C ON T.COUNTERPART = C.NAME
	WHERE C.NAME IS NULL
	AND REASON NOT IN (
	'GIRO DA MIEI CONTI',
	'GIRO VERSO MIEI CONTI',
	'CARTA CREDITO ING DIRECT',
	'RICARICA PREPAGATA'
	)
	GROUP BY REASON, COUNTERPART, Periodo
) AS TRANSACTIONS_WITHOUT_KIND_BY_PERIOD

UNION

SELECT *
FROM (
	SELECT 
	'Totale' AS Spesa,
	'' AS Controparte,
	 '' AS Periodo,
	SUM(CURRENCY_AMOUNT) AS Importo
	FROM TRANSACTIONS
	WHERE REASON NOT IN (
	'GIRO DA MIEI CONTI',
	'GIRO VERSO MIEI CONTI',
	'CARTA CREDITO ING DIRECT',
	'RICARICA PREPAGATA'
	)
) AS TRANSACTIONS_TOTAL_AMOUNT;

--Insert statements for new counterparties
SELECT CONCAT('INSERT INTO COUNTERPARTIES (NAME, EXPENSE_KIND) VALUES (''', T.COUNTERPART, ''', '''');') AS INSERT_STMT
FROM TRANSACTIONS T
LEFT JOIN COUNTERPARTIES C
ON T.COUNTERPART = C.NAME
WHERE C.EXPENSE_KIND IS NULL;

--Yearly expenses means
SELECT Spesa, SUM(Importo) / 12
FROM (
SELECT *
FROM (
	SELECT 
	C.EXPENSE_KIND AS Spesa,
	''  AS Controparte,
	DATE_FORMAT(VALUE_DATE, "%Y-%m") AS Periodo,
	SUM(CURRENCY_AMOUNT) AS Importo
	FROM TRANSACTIONS T
	JOIN COUNTERPARTIES C ON T.COUNTERPART = C.NAME
    WHERE VALUE_DATE >= '2018-01-01' AND VALUE_DATE <= '2018-12-31'
	GROUP BY Spesa, Periodo
) AS TRANSACTIONS_BY_KIND_PERIOD

UNION

SELECT *
FROM (
	SELECT 
	REASON AS Spesa,
	COUNTERPART AS Controparte,
	DATE_FORMAT(VALUE_DATE, "%Y-%m") AS Periodo,
	SUM(CURRENCY_AMOUNT) AS Importo
	FROM TRANSACTIONS T
	LEFT JOIN COUNTERPARTIES C ON T.COUNTERPART = C.NAME
	WHERE C.NAME IS NULL
	AND REASON NOT IN (
	'GIRO DA MIEI CONTI',
	'GIRO VERSO MIEI CONTI',
	'CARTA CREDITO ING DIRECT',
	'RICARICA PREPAGATA'
	)
    AND VALUE_DATE >= '2018-01-01' AND VALUE_DATE <= '2018-12-31'
	GROUP BY REASON, COUNTERPART, Periodo
) AS TRANSACTIONS_WITHOUT_KIND_BY_PERIOD
) AS MEANS
GROUP BY Spesa;

--Monthly balances
SELECT 
  DATE_FORMAT(VALUE_DATE, "%Y-%m") AS Periodo,
  SUM(CURRENCY_AMOUNT) AS Importo
FROM TRANSACTIONS T
JOIN COUNTERPARTIES C
  ON T.COUNTERPART = C.NAME
WHERE VALUE_DATE >= '2018-01-01' AND VALUE_DATE <= '2018-12-31'
GROUP BY Periodo;
